import { getCuteDynamicReply } from "./cuteReplies.js";
import { createFlexMenu } from "./flexMenu.js";
import { sendTelegramAlert, sendTelegramPhoto, getLineProfile } from "../services/telegramService.js";
import { getLineImage } from "../services/lineMediaService.js";

/**
 * ‚úÖ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Telegram ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
 * - ‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠ OA (‡∏°‡∏≤‡∏à‡∏≤‡∏Å process.env.LINE_OA_NAME)
 * - ‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠ displayName ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å LINE API)
 * - ‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏î
 * - ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏£‡∏π‡∏õ ‚Üí ‡∏™‡πà‡∏á‡∏†‡∏≤‡∏û‡πÑ‡∏õ Telegram ‡∏î‡πâ‡∏ß‡∏¢
 */
async function notifyAdmin(event, message) {
  try {
    const profile = await getLineProfile(event.source?.userId);
    const displayName = profile?.displayName || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠";
    const oaName = process.env.LINE_OA_NAME || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö OA";

    let text =
      `üì¢ <b>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏à‡∏≤‡∏Å LINE OA:</b> ${oaName}\n` +
      `üë§ <b>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</b> ${displayName}\n` +
      `üí¨ <b>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°:</b> ${message}`;

    await sendTelegramAlert(text);

    // ‚úÖ ‡∏ñ‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ ‚Üí ‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å LINE API ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ Telegram
    if (event.message?.type === "image" && event.message.id) {
      const photoUrl = await getLineImage(event.message.id);
      if (photoUrl) {
        await sendTelegramPhoto(photoUrl, `üì∑ ‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (${displayName})`);
      }
    }
  } catch (err) {
    console.error("‚ùå notifyAdmin Error:", err);
  }
}

/**
 * ‚úÖ Flow ‡∏´‡∏•‡∏±‡∏Å ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°
 */
export async function handleCustomerFlow(event) {
  const userText = event.message?.text || "";
  const replyMessages = [];

  // üü¢ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô
  if (event.type === "follow") {
    const welcomeMsg = await getCuteDynamicReply(
      "‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡∏±‡∏ö‡πÄ‡∏£‡∏≤‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞ üéâ ‡πÄ‡∏ß‡πá‡∏ö PGTHAI289 ‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡∏ù‡∏≤‡∏Å-‡∏ñ‡∏≠‡∏ô‡∏≠‡∏≠‡πÇ‡∏ï‡πâ ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏ä‡∏ß‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏°‡∏≤‡πÄ‡∏•‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞ üíï"
    );

    replyMessages.push({ type: "text", text: welcomeMsg });
    replyMessages.push(createFlexMenu());

    await notifyAdmin(event, "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà");
    return replyMessages;
  }

  // üü¢ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô Flex
  if (event.type === "postback" && event.postback?.data) {
    const buttonData = event.postback.data;
    await notifyAdmin(event, `‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°: ${buttonData}`);

    const replies = {
      register_admin: "‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏≠‡πÄ‡∏•‡∏ó ‡πÅ‡∏•‡∏∞‡πÑ‡∏≠‡∏î‡∏µ‡πÑ‡∏•‡∏ô‡πå‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞ üíï",
      login_backup: "‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠+‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏ß‡πâ‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡πâ‡∏≠‡∏á‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏≤ üíï",
      issue_deposit: "‡∏û‡∏µ‡πà‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠+‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡πâ‡∏≠‡∏á‡∏à‡∏∞‡∏£‡∏µ‡∏ö‡∏î‡∏π‡πÅ‡∏•‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏≤ üíï",
      issue_withdraw: "‡∏¢‡∏≠‡∏î‡∏ñ‡∏≠‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 3-5 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏Ñ‡πà‡∏≤ üíï",
      forgot_password: "‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠+‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏ß‡πâ‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡πâ‡∏≠‡∏á‡∏à‡∏∞‡∏£‡∏µ‡∏ö‡∏ä‡πà‡∏ß‡∏¢‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡πà‡∏≤ üíï",
      promo_info: "‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏£‡∏≤‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà ‡∏ù‡∏≤‡∏Å‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡πÇ‡∏õ‡∏£‡∏Ñ‡∏∑‡∏ô‡∏¢‡∏≠‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üíï ‡∏™‡∏ô‡πÉ‡∏à‡πÇ‡∏õ‡∏£‡πÑ‡∏´‡∏ô‡∏ö‡∏≠‡∏Å‡∏ô‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞",
    };

    const replyText = replies[buttonData] || "‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡πâ‡∏≠‡∏á‡∏à‡∏∞‡∏£‡∏µ‡∏ö‡∏î‡∏π‡πÅ‡∏•‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞ üíï";

    replyMessages.push({
      type: "text",
      text: await getCuteDynamicReply(replyText),
    });

    return replyMessages;
  }

  // üü¢ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏≠‡∏á
  if (event.type === "message") {
    await notifyAdmin(event, userText || "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°/‡∏£‡∏π‡∏õ");

    replyMessages.push({
      type: "text",
      text: await getCuteDynamicReply(
        "‡∏ô‡πâ‡∏≠‡∏á‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π‡πÅ‡∏•‡πÉ‡∏´‡πâ‡∏û‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏∞‡∏Ñ‡∏∞ üíï ‡∏ù‡∏≤‡∏Å‡∏ö‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏°‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏™‡∏ô‡∏∏‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏£‡∏≤‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á‡∏™‡∏∏‡∏î‡πÜ ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏≤ üéâ"
      ),
    });

    replyMessages.push(createFlexMenu());
    return replyMessages;
  }

  return [];
}
