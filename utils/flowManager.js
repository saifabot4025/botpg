import { getCuteDynamicReply } from "./cuteReplies.js";
import { createFlexMenu } from "./flexMenu.js";
import { sendTelegramAlert, sendTelegramPhoto, getLineProfile } from "../services/telegramService.js";
import { getLineImage } from "../services/lineMediaService.js";

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô + ‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
async function notifyAdmin(event, message) {
  try {
    const profile = await getLineProfile(event.source?.userId);
    const displayName = profile?.displayName || event.source?.userId || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠";
    const oaName = process.env.LINE_OA_NAME || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö OA";

    const text =
      `üì¢ <b>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏à‡∏≤‡∏Å LINE OA:</b> ${oaName}\n` +
      `üë§ <b>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</b> ${displayName}\n` +
      `üí¨ <b>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°:</b> ${message}`;

    await sendTelegramAlert(text);

    if (event.message?.type === "image" && event.message.id) {
      const photoBuffer = await getLineImage(event.message.id);
      if (photoBuffer) {
        await sendTelegramPhoto(photoBuffer, `üì∑ ‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (${displayName})`);
      }
    }
  } catch (err) {
    console.error("notifyAdmin Error:", err);
  }
}

// ‚úÖ ‡πÉ‡∏ä‡πâ GPT ‡∏ä‡πà‡∏ß‡∏¢‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ó‡πÄ‡∏ß‡πá‡∏ö
async function gptEnhancedReply(baseText) {
  const promoTemplates = [
    "‡πÄ‡∏ß‡πá‡∏ö PGTHAI289 ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏™‡∏∏‡∏î‡πÜ üíé ‡∏ù‡∏≤‡∏Å‡∏ñ‡∏≠‡∏ô‡∏≠‡∏≠‡πÇ‡∏ï‡πâ‡πÑ‡∏ß‡∏°‡∏≤‡∏Å ‡∏•‡∏≠‡∏á‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞",
    "‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏±‡∏ö PGTHAI289 ‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏ü‡∏¥‡∏ô‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô üé∞ ‡πÅ‡∏ï‡∏Å‡∏á‡πà‡∏≤‡∏¢ ‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏ä‡∏ß‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞",
    "PGTHAI289 ‡πÄ‡∏ß‡πá‡∏ö‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 1 ‡∏ó‡∏µ‡πà‡πÉ‡∏Ñ‡∏£‡πÜ ‡∏Å‡πá‡πÄ‡∏•‡∏∑‡∏≠‡∏Å üíï ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏á‡πà‡∏≤‡∏¢ ‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏Å‡∏á‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏≤",
    "‡∏û‡∏µ‡πà‡∏•‡∏≠‡∏á‡∏ù‡∏≤‡∏Å‡∏Å‡∏±‡∏ö PGTHAI289 ‡∏™‡∏¥‡∏Ñ‡∏∞ üíñ ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏≠‡πÇ‡∏ï‡πâ‡∏ó‡∏±‡∏ô‡πÉ‡∏à ‡πÅ‡∏ñ‡∏°‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏î‡∏µ‡πÜ ‡πÄ‡∏û‡∏µ‡∏¢‡∏ö‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏≤",
  ];
  const promoText = promoTemplates[Math.floor(Math.random() * promoTemplates.length)];

  return getCuteDynamicReply(`${baseText} üåü ${promoText}`);
}

export async function handleCustomerFlow(event) {
  const replyMessages = [];
  const userText = event.message?.text || "";

  // üü¢ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô
  if (event.type === "follow") {
    const welcomeMsg = await gptEnhancedReply(
      "‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡∏±‡∏ö‡πÄ‡∏£‡∏≤‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞ üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß PGTHAI289 ‡∏Ñ‡πà‡∏≤"
    );
    replyMessages.push({ type: "text", text: welcomeMsg });
    replyMessages.push(createFlexMenu());
    await notifyAdmin(event, "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà");
    return replyMessages;
  }

  // üü¢ ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô Flex
  if (event.type === "postback" && event.postback?.data) {
    const data = event.postback.data;
    await notifyAdmin(event, `‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°: ${data}`);

    const replies = {
      register_admin: "‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏≠‡πÄ‡∏•‡∏ó ‡πÅ‡∏•‡∏∞‡πÑ‡∏≠‡∏î‡∏µ‡πÑ‡∏•‡∏ô‡πå‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡πâ‡∏≠‡∏á‡∏à‡∏∞‡∏î‡∏π‡πÅ‡∏•‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á‡∏Ñ‡πà‡∏≤ üíï",
      login_backup: "‡∏û‡∏µ‡πà‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠+‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏ß‡πâ‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡πâ‡∏≠‡∏á‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏≤ üíï",
      issue_deposit: "‡∏Ç‡∏≠‡∏ä‡∏∑‡πà‡∏≠+‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡∏ô‡πâ‡∏≠‡∏á‡∏à‡∏∞‡∏£‡∏µ‡∏ö‡∏ä‡πà‡∏ß‡∏¢‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏≤ üíï",
      issue_withdraw: "‡∏¢‡∏≠‡∏î‡∏ñ‡∏≠‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 3-5 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏Ñ‡πà‡∏≤ üíï",
      forgot_password: "‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠+‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏ß‡πâ‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡∏ô‡πâ‡∏≠‡∏á‡∏à‡∏∞‡∏£‡∏µ‡∏ö‡∏ä‡πà‡∏ß‡∏¢‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏≤ üíï",
      promo_info: "‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏£‡∏≤‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà ‡∏ù‡∏≤‡∏Å‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡πÇ‡∏õ‡∏£‡∏Ñ‡∏∑‡∏ô‡∏¢‡∏≠‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏≤ ‡∏™‡∏ô‡πÉ‡∏à‡πÇ‡∏õ‡∏£‡πÑ‡∏´‡∏ô‡∏ö‡∏≠‡∏Å‡∏ô‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞ üíï",
    };

    const replyText = replies[data] || "‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡πâ‡∏≠‡∏á‡∏à‡∏∞‡∏£‡∏µ‡∏ö‡∏î‡∏π‡πÅ‡∏•‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞ üíï";
    replyMessages.push({
      type: "text",
      text: await gptEnhancedReply(replyText),
    });

    return replyMessages;
  }

  // üü¢ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
  if (event.type === "message") {
    await notifyAdmin(event, userText || "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°/‡∏£‡∏π‡∏õ");

    const replyText = await gptEnhancedReply(
      "‡∏ô‡πâ‡∏≠‡∏á‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π‡πÅ‡∏•‡πÉ‡∏´‡πâ‡∏û‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡∏ù‡∏≤‡∏Å‡∏ö‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏°‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏™‡∏ô‡∏∏‡∏Å‡∏Å‡∏±‡∏ö‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏£‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏≤ üíï"
    );

    replyMessages.push({ type: "text", text: replyText });
    replyMessages.push(createFlexMenu());
    return replyMessages;
  }

  return [];
}
