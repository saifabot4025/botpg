/* ================== FLOW MANAGER (FINAL PRO VERSION) ================== */
import { getCuteDynamicReply } from "../services/gptService.js";
import { sendTelegramAlert, sendTelegramPhoto, getLineProfile } from "../services/telegramService.js";
import { getLineImage } from "../services/lineMediaService.js";
import fs from "fs";

/* ================== STATE ================== */
const userStates = {};
const userPausedStates = {};
const flexCooldown = 2 * 60 * 60 * 1000; // 2 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
const greetCooldown = 10 * 60 * 1000; // 10 ‡∏ô‡∏≤‡∏ó‡∏µ

function getUserState(userId) {
  if (!userStates[userId]) {
    userStates[userId] = {
      lastFlexSent: 0,
      lastGreeted: 0,
      currentCase: null,
      caseData: {},
      lastActive: Date.now(),
      chatHistory: [],
      totalDeposit: 0
    };
  }
  return userStates[userId];
}

function updateUserState(userId, newState) {
  userStates[userId] = { ...getUserState(userId), ...newState };
}

function shouldSendFlex(userId) {
  const state = getUserState(userId);
  return Date.now() - state.lastFlexSent > flexCooldown;
}

function shouldGreet(userId) {
  const state = getUserState(userId);
  return Date.now() - state.lastGreeted > greetCooldown;
}

/* ================== UTILITIES ================== */
function randomMaskedPhone() {
  const prefix = "08";
  const suffix = Math.floor(1000 + Math.random() * 9000);
  return `${prefix}xxxx${suffix}`;
}

async function getRandomName() {
  try {
    const name = await getCuteDynamicReply("‡∏™‡∏∏‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏ô‡πÑ‡∏ó‡∏¢ 1 ‡∏ä‡∏∑‡πà‡∏≠ ‡∏ï‡∏≠‡∏ö‡πÅ‡∏Ñ‡πà‡∏ä‡∏∑‡πà‡∏≠");
    return name.replace(/\n/g, "").trim();
  } catch {
    const fallback = ["‡∏ü‡πâ‡∏≤", "‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•", "‡∏Å‡∏¥‡πä‡∏ü", "‡∏ù‡∏ô", "‡∏ô‡πâ‡∏≠‡∏á‡πÄ‡∏ô‡∏¢", "‡∏û‡∏¥‡∏°", "‡∏à‡πã‡∏≤", "‡∏Ç‡∏ô‡∏°", "‡∏ù‡πâ‡∏≤‡∏¢", "‡πÄ‡∏Å‡∏î"];
    return fallback[Math.floor(Math.random() * fallback.length)];
  }
}

async function notifyAdmin(event, msg) {
  try {
    const profile = await getLineProfile(event.source?.userId);
    const name = profile?.displayName || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠";
    const oa = process.env.LINE_OA_NAME || "OA";
    await sendTelegramAlert(`üì¢ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏à‡∏≤‡∏Å ${oa}\nüë§ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${name}\nüí¨ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°: ${msg}`);
    if (event.message?.type === "image") {
      const photo = await getLineImage(event.message.id);
      if (photo) await sendTelegramPhoto(photo, `üì∑ ‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (${name})`);
    }
  } catch (err) { console.error("notifyAdmin error:", err); }
}

/* ================== MESSAGE GENERATORS ================== */
async function generateWithdrawReviewMessage() {
  const reviews = [];
  for (let i=0;i<10;i++){
    const phone = randomMaskedPhone();
    const amt = (Math.floor(Math.random()*45000)+5000).toLocaleString();
    reviews.push(`‡∏¢‡∏π‡∏™ ${phone} ‡∏ñ‡∏≠‡∏ô ${amt}`);
  }
  return `üìä ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î\n\n${reviews.join("\n")}\n\n‡πÄ‡∏ß‡πá‡∏ö‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á üíï`;
}

async function generateMaxWithdrawMessage() {
  const today = new Date().toLocaleDateString("th-TH");
  if (!global.cachedDate || global.cachedDate !== today) {
    global.cachedDate = today;
    global.cachedName = await getRandomName();
    global.cachedAmt = Math.floor(Math.random()*200000)+300000;
  }
  return `üëë ‡∏¢‡∏≠‡∏î‡∏ñ‡∏≠‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ\n\n‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏Å‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì "${global.cachedName}" ‡∏¢‡∏π‡∏™ ${randomMaskedPhone()} ‡∏ñ‡∏≠‡∏ô ${global.cachedAmt.toLocaleString()} ‡∏ö‡∏≤‡∏ó\n‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${today}`;
}

async function generateTopGameMessage() {
  const games = [
    "Graffiti Rush ‚Ä¢ ‡∏Å‡∏£‡∏≤‡∏ü‡∏ü‡∏¥‡∏ï‡∏µ‡πâ ‡∏£‡∏±‡∏ä",
    "Treasures of Aztec ‚Ä¢ ‡∏™‡∏≤‡∏ß‡∏ñ‡πâ‡∏≥",
    "Fortune Ox ‚Ä¢ ‡∏ß‡∏±‡∏ß‡πÇ‡∏î‡∏î",
    "Fortune Snake ‚Ä¢ ‡∏á‡∏π‡∏ó‡∏≠‡∏á",
    "Fortune Rabbit ‚Ä¢ ‡∏Å‡∏£‡∏∞‡∏ï‡πà‡∏≤‡∏¢‡πÇ‡∏ä‡∏Ñ‡∏•‡∏≤‡∏†",
    "Lucky Neko ‚Ä¢ ‡πÅ‡∏°‡∏ß‡∏Å‡∏ß‡∏±‡∏Å",
    "Fortune Mouse ‚Ä¢ ‡∏´‡∏ô‡∏π‡∏ó‡∏≠‡∏á",
    "Dragon Hatch ‚Ä¢ ‡∏£‡∏±‡∏á‡∏°‡∏±‡∏á‡∏Å‡∏£",
    "Wild Bounty Showdown ‚Ä¢ ‡∏Ñ‡∏≤‡∏ß‡∏ö‡∏≠‡∏¢",
    "Ways of the Qilin ‚Ä¢ ‡∏Å‡∏¥‡πÄ‡∏•‡∏ô",
    "Galaxy Miner ‚Ä¢ ‡∏ô‡∏±‡∏Å‡∏Ç‡∏∏‡∏î‡∏≠‡∏ß‡∏Å‡∏≤‡∏®",
    "Incan Wonders ‚Ä¢ ‡∏™‡∏¥‡πà‡∏á‡∏°‡∏´‡∏±‡∏®‡∏à‡∏£‡∏£‡∏¢‡πå‡∏≠‡∏¥‡∏ô‡∏Ñ‡∏≤",
    "Diner Frenzy Spins ‚Ä¢ ‡∏°‡∏∑‡πâ‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏∏‡∏î‡∏õ‡∏±‡∏á",
    "Dragon's Treasure Quest ‚Ä¢ ‡∏°‡∏±‡∏á‡∏Å‡∏£‡∏ã‡πà‡∏≠‡∏ô‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥",
    "Jack the Giant Hunter ‚Ä¢ ‡πÅ‡∏à‡πá‡∏Å‡∏ú‡∏π‡πâ‡∏Ü‡πà‡∏≤‡∏¢‡∏±‡∏Å‡∏©‡πå"
  ];
  const selected = games.sort(()=>0.5-Math.random()).slice(0,5);
  const freeSpin = Math.floor(Math.random()*(500000-50000))+50000;
  const normal = Math.floor(Math.random()*(50000-5000))+5000;
  let msg = "üé≤ ‡πÄ‡∏Å‡∏°‡∏™‡∏•‡πá‡∏≠‡∏ï‡πÅ‡∏ï‡∏Å‡∏ö‡πà‡∏≠‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ\n\n";
  selected.forEach((g,i)=>msg += `${i+1}. ${g} - ${Math.floor(Math.random()*20)+80}%\n`);
  msg += `\nüí• ‡∏ü‡∏£‡∏µ‡∏™‡∏õ‡∏¥‡∏ô‡πÅ‡∏ï‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${freeSpin.toLocaleString()} ‡∏ö‡∏≤‡∏ó\nüí• ‡∏õ‡∏±‡πà‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤‡πÅ‡∏ï‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${normal.toLocaleString()} ‡∏ö‡∏≤‡∏ó\n‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏•‡∏¢ ‡πÅ‡∏ï‡∏Å‡∏á‡πà‡∏≤‡∏¢ ‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á üíï`;
  return msg;
}

async function generateReferralCommissionMessage() {
  const lines=[];
  for (let i=0;i<10;i++){
    const phone = randomMaskedPhone();
    const amt=(Math.floor(Math.random()*97000)+3000).toLocaleString();
    lines.push(`‡∏¢‡∏π‡∏™ ${phone} ‡πÑ‡∏î‡πâ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô ${amt}`);
  }
  return `ü§ù ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô\n\n${lines.join("\n")}\n\nüí° ‡∏ä‡∏ß‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏°‡∏≤‡πÄ‡∏•‡πà‡∏ô ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô!`;
}

/* ================== FLEX ================== */
function createFlexMenuContents(){
  return {
    type:"carousel",
    contents:[
      /* BOX 1 */
      {
        type:"bubble",
        hero:{type:"image",url:"https://i.ibb.co/SqbNcr1/image.jpg",size:"full",aspectRatio:"20:13",aspectMode:"cover"},
        body:{type:"box",layout:"vertical",contents:[
          {type:"text",text:"PGTHAI289",weight:"bold",size:"xl",color:"#FFD700"},
          {type:"text",text:"‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏á‡πà‡∏≤‡∏¢ ‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢",size:"sm",color:"#FFFFFF",wrap:true}
        ]},
        footer:{type:"box",layout:"vertical",contents:[
          {type:"button",style:"primary",color:"#FFD700",action:{type:"uri",label:"‚≠ê ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏≠‡∏á",uri:"https://pgthai289.net/customer/register/LINEBOT/?openExternalBrowser=1"}},
          {type:"button",style:"secondary",color:"#333333",action:{type:"postback",label:"üì≤ ‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏´‡πâ",data:"register_admin"}},
          {type:"button",style:"primary",color:"#FFD700",action:{type:"uri",label:"üîë ‡∏ó‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô‡∏´‡∏•‡∏±‡∏Å",uri:"https://pgthai289.net/?openExternalBrowser=1"}},
          {type:"button",style:"secondary",color:"#333333",action:{type:"postback",label:"üö™ ‡∏ó‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á",data:"login_backup"}}
        ]}
      },
      /* BOX 2 */
      {
        type:"bubble",
        hero:{type:"image",url:"https://i.ibb.co/SqbNcr1/image.jpg",size:"full",aspectRatio:"20:13",aspectMode:"cover"},
        body:{type:"box",layout:"vertical",contents:[
          {type:"text",text:"PGTHAI289",weight:"bold",size:"xl",color:"#FFD700"},
          {type:"text",text:"‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤ & ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô",size:"sm",color:"#FFFFFF",wrap:true}
        ]},
        footer:{type:"box",layout:"vertical",contents:[
          {type:"button",style:"primary",color:"#FFD700",action:{type:"postback",label:"üí∞ ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ù‡∏≤‡∏Å/‡∏ñ‡∏≠‡∏ô",data:"issue_deposit"}},
          {type:"button",style:"secondary",color:"#333333",action:{type:"postback",label:"üîë ‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô",data:"forgot_password"}},
          {type:"button",style:"primary",color:"#FFD700",action:{type:"postback",label:"üö™ ‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ",data:"login_backup"}},
          {type:"button",style:"secondary",color:"#333333",action:{type:"postback",label:"üéÅ ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°",data:"promo_info"}}
        ]}
      },
      /* BOX 3 */
      {
        type:"bubble",
        hero:{type:"image",url:"https://i.ibb.co/SqbNcr1/image.jpg",size:"full",aspectRatio:"20:13",aspectMode:"cover"},
        body:{type:"box",layout:"vertical",contents:[
          {type:"text",text:"PGTHAI289",weight:"bold",size:"xl",color:"#FFD700"},
          {type:"text",text:"‡∏£‡∏µ‡∏ß‡∏¥‡∏ß & ‡πÄ‡∏Å‡∏°‡πÅ‡∏ï‡∏Å",size:"sm",color:"#FFFFFF",wrap:true}
        ]},
        footer:{type:"box",layout:"vertical",contents:[
          {type:"button",style:"primary",color:"#FFD700",action:{type:"postback",label:"‚≠ê ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏ñ‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î",data:"review_withdraw"}},
          {type:"button",style:"secondary",color:"#333333",action:{type:"postback",label:"üëë ‡∏ñ‡∏≠‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ",data:"max_withdraw"}},
          {type:"button",style:"primary",color:"#FFD700",action:{type:"postback",label:"üéÆ ‡πÄ‡∏Å‡∏°‡πÅ‡∏ï‡∏Å‡∏ö‡πà‡∏≠‡∏¢",data:"top_game"}},
          {type:"button",style:"secondary",color:"#333333",action:{type:"postback",label:"üíé ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô",data:"referral_commission"}}
        ]}
      }
    ]
  };
}

/* ================== MAIN FLOW ================== */
export async function handleCustomerFlow(event){
  const userId=event.source?.userId;
  const state=getUserState(userId);
  const reply=[];
  const text=event.message?.text?.trim()||"";

  if(userPausedStates[userId]){
    if(text.includes("‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏∞‡∏Ñ‡∏∞‡∏û‡∏µ‡πà")){
      userPausedStates[userId]=false;
      updateUserState(userId,{currentCase:null,caseData:{}});
      reply.push({type:"text",text:"‡∏ô‡πâ‡∏≠‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏î‡∏π‡πÅ‡∏•‡∏û‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞ üíï"});
    }else{
      reply.push({type:"text",text:"‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ù‡πà‡∏≤‡∏¢‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡πà‡∏∞ üíï"});
    }
    return reply;
  }

  if(event.type==="follow" && shouldGreet(userId)){
    reply.push({type:"text",text:`‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞ ‡∏ô‡πâ‡∏≠‡∏á‡∏ü‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏î‡∏π‡πÅ‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á PGTHAI289 ‡∏ô‡∏∞‡∏Ñ‡∏∞ üíï`});
    reply.push({type:"flex",altText:"üéÄ ‡πÄ‡∏°‡∏ô‡∏π‡∏û‡∏¥‡πÄ‡∏®‡∏©",contents:createFlexMenuContents()});
    updateUserState(userId,{lastFlexSent:Date.now(),lastGreeted:Date.now()});
    await notifyAdmin(event,"‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà");
    return reply;
  }

  if(event.type==="postback" && event.postback?.data){
    const data=event.postback.data;
    reply.push({type:"text",text:`‚úÖ ‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°: ${data}`});
    let msg="";
    if(data==="register_admin"){ msg="‡∏Ç‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ/‡∏ß‡∏≠‡πÄ‡∏•‡∏ó ‡πÅ‡∏•‡∏∞‡πÑ‡∏≠‡∏î‡∏µ‡πÑ‡∏•‡∏ô‡πå‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞ üíï"; userPausedStates[userId]=true; }
    if(data==="login_backup"){ msg="‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡πà‡∏∞ üíï"; userPausedStates[userId]=true; }
    if(data==="issue_deposit"){ msg="‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠+‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏™‡∏•‡∏¥‡∏õ‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ô‡∏∞‡∏Ñ‡∏∞ üíï"; userPausedStates[userId]=true; }
    if(data==="forgot_password"){ msg="‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠+‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏ß‡πâ ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡πâ‡∏≠‡∏á‡∏ä‡πà‡∏ß‡∏¢‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÉ‡∏´‡πâ‡∏Ñ‡πà‡∏∞ üíï"; userPausedStates[userId]=true; }
    if(data==="promo_info"){ msg="‡∏û‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏Ñ‡∏∞ ‡∏ö‡∏≠‡∏• ‡∏™‡∏•‡πá‡∏≠‡∏ï ‡∏´‡∏ß‡∏¢ ‡∏Ñ‡∏≤‡∏™‡∏¥‡πÇ‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏∑‡πà‡∏ô‡πÜ üíï"; userPausedStates[userId]=true; }
    if(data==="review_withdraw"){ msg=await generateWithdrawReviewMessage(); }
    if(data==="max_withdraw"){ msg=await generateMaxWithdrawMessage(); }
    if(data==="top_game"){ msg=await generateTopGameMessage(); }
    if(data==="referral_commission"){ msg=await generateReferralCommissionMessage(); }
    reply.push({type:"text",text:msg});
    await notifyAdmin(event,`‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° ${data}`);
    return reply;
  }

  if(state.currentCase && (text.length>3 || event.message?.type==="image")){
    reply.push({type:"text",text:"‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ù‡πà‡∏≤‡∏¢‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ üíï"});
    userPausedStates[userId]=true;
    await notifyAdmin(event,`‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏Ñ‡∏™ ${state.currentCase}): ${text||"‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ"}`);
    return reply;
  }

  if(event.type==="message" && shouldSendFlex(userId)){
    reply.push({type:"flex",altText:"üéÄ ‡πÄ‡∏°‡∏ô‡∏π‡∏û‡∏¥‡πÄ‡∏®‡∏©",contents:createFlexMenuContents()});
    updateUserState(userId,{lastFlexSent:Date.now()});
  }

  try{
    const gptReply=await getCuteDynamicReply(`‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏û‡∏π‡∏î‡∏ß‡πà‡∏≤: "${text}"\n‡∏ï‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Ñ‡∏∏‡∏¢‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å ‡∏≠‡πâ‡∏≠‡∏ô‡πÜ ‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏•‡πà‡∏ô PGTHAI289`);
    reply.push({type:"text",text:gptReply});
    await notifyAdmin(event,text||"‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°/‡∏£‡∏π‡∏õ");
    return reply;
  }catch(err){
    reply.push({type:"text",text:"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡πà‡∏∞ üíï"});
    return reply;
  }
}

/* ================== CRM ================== */
export function initCRM(lineClient){
  setInterval(async()=>{
    const now=Date.now();
    const inactive=Object.keys(userStates).filter(uid=>now-(userStates[uid]?.lastActive||0)>3*24*60*60*1000);
    for(const uid of inactive){
      try{
        const follow=await getCuteDynamicReply("‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å ‡∏ä‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢‡πÑ‡∏õ 3 ‡∏ß‡∏±‡∏ô ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏•‡πà‡∏ô PGTHAI289 ‡πÅ‡∏ö‡∏ö‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û");
        await lineClient.pushMessage(uid,{type:"text",text:follow});
        await lineClient.pushMessage(uid,{type:"flex",altText:"üéÄ ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏±‡∏ö‡πÄ‡∏£‡∏≤ üéÄ",contents:createFlexMenuContents()});
        await sendTelegramAlert(`üì¢ CRM ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏≤: ${uid}`);
        updateUserState(uid,{lastActive:Date.now()});
      }catch(err){ console.error("CRM error:",err); }
    }
  },6*60*60*1000);
}


/* ================== CRM FOLLOW-UP (3,7,15,30 ‡∏ß‡∏±‡∏ô) ================== */
export function initCRM(lineClient) {
  setInterval(async () => {
    const now = Date.now();
    const followupPeriods = [
      { days: 3, prompt: "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å ‡∏ä‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢‡πÑ‡∏õ 3 ‡∏ß‡∏±‡∏ô ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏•‡πà‡∏ô PGTHAI289 ‡πÅ‡∏ö‡∏ö‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û" },
      { days: 7, prompt: "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢‡πÑ‡∏õ 7 ‡∏ß‡∏±‡∏ô ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏•‡πà‡∏ô PGTHAI289 ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡∏î‡∏µ‡πÜ ‡∏£‡∏≠‡∏≠‡∏¢‡∏π‡πà" },
      { days: 15, prompt: "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢‡πÑ‡∏õ 15 ‡∏ß‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏•‡πà‡∏ô PGTHAI289 ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏û‡∏π‡∏î‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô" },
      { days: 30, prompt: "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏ä‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢‡πÑ‡∏õ 30 ‡∏ß‡∏±‡∏ô ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏•‡πà‡∏ô PGTHAI289 ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏≠‡∏Å‡∏ñ‡∏∂‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏î‡πá‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà" },
    ];

    for (const period of followupPeriods) {
      const inactive = Object.keys(userStates).filter(
        uid => now - (userStates[uid]?.lastActive || 0) > period.days * 24 * 60 * 60 * 1000
      );
      for (const uid of inactive) {
        try {
          const msg = await getCuteDynamicReply(period.prompt);
          await lineClient.pushMessage(uid, { type: "text", text: msg });
          await lineClient.pushMessage(uid, { type: "flex", altText: "üéÄ ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏±‡∏ö‡πÄ‡∏£‡∏≤ üéÄ", contents: createFlexMenuContents() });
          await sendTelegramAlert(`üì¢ CRM (${period.days} ‡∏ß‡∏±‡∏ô) ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏≤: ${uid}`);
          updateUserState(uid, { lastActive: Date.now() });
        } catch (err) {
          console.error(`CRM Error (${period.days} ‡∏ß‡∏±‡∏ô):`, err);
        }
      }
    }
  }, 6 * 60 * 60 * 1000);
}
