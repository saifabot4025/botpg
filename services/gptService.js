// services/gptService.js
import OpenAI from "openai";
import { staffNames } from "../utils/staffNames.js";

const client = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÅ‡∏ö‡∏ö "‡∏â‡∏•‡∏≤‡∏î" ‡∏û‡∏£‡πâ‡∏≠‡∏° feed history ‡πÅ‡∏ä‡∏ó‡πÅ‡∏•‡∏∞‡∏•‡πá‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ 10 ‡∏ô‡∏≤‡∏ó‡∏µ
 * @param {string} baseMessage ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
 * @param {string} assistantName ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡∏™‡πà‡∏á‡∏°‡∏≤‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)
 * @param {Array} history ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏ä‡∏ó [{role: "user", content}, {role: "assistant", content}]
 * @returns {Promise<string>}
 */
export async function getCuteDynamicReply(baseMessage, assistantName = null, history = []) {
  const staffName = assistantName || staffNames[Math.floor(Math.random() * staffNames.length)];
  // history ‡∏¢‡πà‡∏≠ 2-3 ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
  const lastHistory = (history || []).slice(-3)
    .map(msg => `${msg.role === "user" ? "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" : staffName}: ${msg.content}`).join("\n");

  // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
  const examples = `
‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏á‡∏ö‡∏≠‡∏•‡∏™‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏Ñ‡πà‡∏∞
${staffName}: ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ ‡πÅ‡∏ó‡∏á‡∏ö‡∏≠‡∏•‡∏™‡∏î‡∏Å‡∏±‡∏ö PGTHAI289 ‡∏á‡πà‡∏≤‡∏¢‡∏°‡∏≤‡∏Å! ‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π‡∏Å‡∏µ‡∏¨‡∏≤ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏π‡πà‡∏ö‡∏≠‡∏•‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏ï‡πá‡∏°‡πÄ‡∏ß‡∏•‡∏≤/‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡πÅ‡∏£‡∏Å/‡∏™‡∏π‡∏á-‡∏ï‡πà‡∏≥ ‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡πà‡∏∞ ‡∏ñ‡πâ‡∏≤‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÑ‡∏´‡∏ô‡∏ñ‡∏≤‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞

‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏°‡∏ô‡∏¢‡∏π‡∏ï‡πà‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà
${staffName}: ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏°‡∏ô‡∏¢‡∏π‡∏ï‡πà‡∏≠ 0.5 ‡∏•‡∏π‡∏Å‡∏Ñ‡πà‡∏∞ ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ï‡∏≤‡∏°‡∏ï‡∏•‡∏≤‡∏î‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏µ‡∏¨‡∏≤‡πÑ‡∏î‡πâ‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞

‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ‡πÇ‡∏õ‡∏£‡∏ù‡∏≤‡∏Å‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á
${staffName}: ‡πÇ‡∏õ‡∏£‡∏ù‡∏≤‡∏Å‡πÅ‡∏£‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡∏£‡∏±‡∏ö‡πÇ‡∏ö‡∏ô‡∏±‡∏™ 20% ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 1,000 ‡∏ö‡∏≤‡∏ó ‡∏ó‡∏≥‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô 3 ‡πÄ‡∏ó‡πà‡∏≤ ‡∏ñ‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ ‡∏™‡∏ô‡πÉ‡∏à‡∏£‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞

‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ‡πÄ‡∏ï‡∏¥‡∏°‡∏ß‡∏≠‡∏•‡πÄ‡∏•‡∏ó‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà
${staffName}: ‡πÄ‡∏ï‡∏¥‡∏°‡∏ú‡πà‡∏≤‡∏ô‡∏ß‡∏≠‡∏•‡πÄ‡∏•‡∏ó‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 1 ‡∏ö‡∏≤‡∏ó‡∏Ñ‡πà‡∏∞ ‡∏ù‡∏≤‡∏Å‡∏ñ‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡πÑ‡∏ß‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏° ‡∏î‡∏π‡∏ß‡∏¥‡∏ò‡∏µ‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏ô‡∏π‡∏ù‡∏≤‡∏Å‡∏ñ‡∏≠‡∏ô‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞
`;

  const prompt = `
‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ú‡∏π‡πâ‡∏´‡∏ç‡∏¥‡∏á‡∏ä‡∏∑‡πà‡∏≠ "${staffName}" ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ß‡πá‡∏ö PGTHAI289
- ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≠‡∏ö‡πÇ‡∏î‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏ä‡∏ó (history) ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
- ‡∏ï‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å ‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á ‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û ‡πÑ‡∏°‡πà‡πÅ‡∏Ç‡πá‡∏á‡∏ó‡∏∑‡πà‡∏≠ ‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏à‡∏≥‡πÄ‡∏à
- ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ï‡πâ‡∏≠‡∏á "‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°" ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å ‡∏´‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ö‡∏≠‡∏•/‡∏™‡∏•‡πá‡∏≠‡∏ï/‡∏Ñ‡∏≤‡∏™‡∏¥‡πÇ‡∏ô/‡πÇ‡∏õ‡∏£/‡∏ù‡∏≤‡∏Å‡∏ñ‡∏≠‡∏ô ‡∏Ø‡∏•‡∏Ø ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö step-by-step ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏Å‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á (‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÜ ‡∏ß‡πà‡∏≤ "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Å‡∏°‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà‡πÄ‡∏á‡∏¥‡∏ô" ‡πÄ‡∏â‡∏¢‡πÜ)
- ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ó‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ó‡∏£‡∏Å‡∏Ç‡∏≤‡∏¢‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏™‡πà‡πÇ‡∏õ‡∏£/‡∏ä‡∏ß‡∏ô‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡πÄ‡∏ô‡∏µ‡∏¢‡∏ô‡πÜ ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
- ‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏ä‡∏ó (‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏™‡∏°‡∏≠ 10 ‡∏ô‡∏≤‡∏ó‡∏µ‡πÅ‡∏£‡∏Å)
- ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢ "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞" ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡∏±‡∏ß‡∏ã‡πâ‡∏≥
- ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡πÉ‡∏à ‡πÉ‡∏´‡πâ‡∏Ç‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏à‡∏£‡∏¥‡∏á/‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö‡∏°‡∏±‡πà‡∏ß

${examples}

${lastHistory ? `‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏ä‡∏ó‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:\n${lastHistory}` : ""}

‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå: ${baseMessage}
`;

  try {
    const completion = await client.chat.completions.create({
      model: "gpt-4o",
      messages: [{ role: "user", content: prompt }],
      temperature: 0.6,
      max_tokens: 320,
    });
    return completion.choices[0].message.content.trim();
  } catch (err) {
    console.error("GPT Error:", err);
    return `${staffName} ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π‡πÅ‡∏•‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏∞‡∏Ñ‡∏∞ üíï`;
  }
}
